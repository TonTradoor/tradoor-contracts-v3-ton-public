#pragma version =0.4.3;
#pragma allow-post-modification;
#pragma compute-asm-ltr;

#include "tact_Pool.headers.fc";
#include "tact_Pool.stdlib.fc";
#include "tact_Pool.constants.fc";
#include "tact_Pool.storage.fc";

;;
;; Contract Pool functions
;;

(int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $Pool$_contract_init(int $deployId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = (50000000, 30000000, null(), 1, 300, 1, 10000000, 100, 200000, 1000000, null(), null(), null(), 1, null(), null(), 1, null(), null(), 0, 0, null(), 1, null(), 0);
    $self'owner = __tact_context_get_sender();
    $self'orderBook = __tact_create_address(0, 0);
    ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity) = $GlobalRBFPosition$_constructor_riskBufferFund_liquidity(0, 0);
    ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth) = $GlobalLPLiquidity$_constructor_margin_liquidity_fundingFeeGrowth_tradingFeeGrowth(0, 0, 0, 0);
    return ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee);
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), (int, int, int, int, int, int, slice)) $Pool$_fun_configData((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $ConfigData$_constructor_rbfLockTime_bonusFactor_minLPMargin_maxLPLeverage_lpLiquidationFee_lpMaxRiskRate_orderBook($self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'orderBook));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), (int, tuple)) $Pool$_fun_tokenConfig((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $tokenId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $TokenConfigData$_constructor_tokenIdNext_tokenConfig($self'tokenIdNext, $TokenConfig$_load_opt(__tact_dict_get_int_cell($self'tokenConfigs, 257, $tokenId))));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_tokenEnabled((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $tokenIndex) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $tokenConfigOpt = $TokenConfig$_load_opt(__tact_dict_get_int_cell($self'tokenConfigs, 257, $tokenIndex));
    if (null?($tokenConfigOpt)) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), false);
    }
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $TokenConfig$_get_enable($TokenConfig$_not_null($tokenConfigOpt)));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_getPrice((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $tokenId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $priceData = $PriceData$_load_opt(__tact_dict_get_int_cell($self'prices, 257, $tokenId));
    int $price = 0;
    if ((~ null?($priceData))) {
        $price = $PriceData$_get_price($PriceData$_not_null($priceData));
    }
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $price);
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_calculateUnrealizedPnL((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $isLong, int $size, int $entryPrice, int $price) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    if ($isLong) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), (($size * ($price - $entryPrice)) / 100000000000000000000));
    } else {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), (($size * ($entryPrice - $price)) / 100000000000000000000));
    }
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_calculateTotalGlobalUnrealizedPnl((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    __tact_debug_str(__gen_slice_string_c6ecc467b09f06d441f92e923a836f96b69fc82924d5d1ce223db1f08fed7c5f());
    int $totalGlobalUnrealizedPnl = 0;
    int $i = 1;
    while (($i < $self'tokenIdNext)) {
        int $tokenEnabled = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_tokenEnabled($i);
        if ($tokenEnabled) {
            tuple $globalLPPositionOpt = $GlobalLPPosition$_load_opt(__tact_dict_get_int_cell($self'globalLPPositions, 257, $i));
            if ((~ null?($globalLPPositionOpt))) {
                var ($globalLPPosition'netSize, $globalLPPosition'isLong, $globalLPPosition'entryPrice) = $GlobalLPPosition$_not_null($globalLPPositionOpt);
                int $indexPrice = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_getPrice($i);
                int $unrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($globalLPPosition'isLong, $globalLPPosition'netSize, $globalLPPosition'entryPrice, $indexPrice);
                $totalGlobalUnrealizedPnl = ($totalGlobalUnrealizedPnl + $unrealizedPnl);
            }
        }
        $i = ($i + 1);
    }
    __tact_debug_str(__tact_int_to_string($totalGlobalUnrealizedPnl));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $totalGlobalUnrealizedPnl);
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), ()) $Pool$_fun_increaseRBFPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, slice $account, int $liquidityDelta, int $trxId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $lpPositionOpt = $RBFPosition$_load_opt(__tact_dict_get_slice_cell($self'rbfPositions, 267, $account));
    var ($rbfPosition'positionId, $rbfPosition'liquidity, $rbfPosition'bonus, $rbfPosition'unlockTime) = $RBFPosition$_constructor_positionId_liquidity_bonus_unlockTime(0, 0, 0, 0);
    if ((~ null?($lpPositionOpt))) {
        ($rbfPosition'positionId, $rbfPosition'liquidity, $rbfPosition'bonus, $rbfPosition'unlockTime) = $RBFPosition$_not_null($lpPositionOpt);
    } else {
        $rbfPosition'positionId = $self'rbfPositionIndexNext;
        $self'rbfPositionIndexNext = ($self'rbfPositionIndexNext + 1);
    }
    int $globalNetRBF = ($self'globalRBFPosition'riskBufferFund + ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl());
    if (($globalNetRBF < 0)) {
        $globalNetRBF = 0;
    }
    int $bonus = 0;
    if (($globalNetRBF < $self'globalRBFPosition'liquidity)) {
        $bonus = ((($self'bonusFactor * ($self'globalRBFPosition'liquidity - $globalNetRBF)) * $liquidityDelta) / $self'globalRBFPosition'liquidity);
        __tact_debug_str(__gen_slice_string_4d1d72adb7b7e894e19166bb81a5119b20f05e2583267c2acabe9e71469ebb7a());
        __tact_debug_str(__tact_int_to_string($bonus));
        $rbfPosition'bonus = ($rbfPosition'bonus + $bonus);
    }
    $rbfPosition'liquidity = ($rbfPosition'liquidity + $liquidityDelta);
    $rbfPosition'unlockTime = (now() + $self'rbfLockTime);
    __tact_debug_str(__gen_slice_string_2bb4c1bdab9517f17315b5b9e241afacaa471bf982a23c000edab53e3caa50d9());
    __tact_debug_str(__tact_int_to_string(cell_hash(end_cell(__tact_store_address(begin_cell(), $account)))));
    $self'rbfPositions~__tact_dict_set_slice_cell(267, $account, $RBFPosition$_store_cell(($rbfPosition'positionId, $rbfPosition'liquidity, $rbfPosition'bonus, $rbfPosition'unlockTime)));
    $self'globalRBFPosition'riskBufferFund = ($self'globalRBFPosition'riskBufferFund + $liquidityDelta);
    $self'globalRBFPosition'liquidity = ($self'globalRBFPosition'liquidity + $liquidityDelta);
    $global_emit($RBFPositionIncreasedEvent$_store_cell($RBFPositionIncreasedEvent$_constructor_positionId_account_liquidityDelta_liquidityAfter_bonusDelta_bonusAfter_unlockTimeAfter_trxId($rbfPosition'positionId, $account, $liquidityDelta, $rbfPosition'liquidity, $bonus, $rbfPosition'bonus, $rbfPosition'unlockTime, $trxId)));
    $global_emit($GlobalRBFChangedEvent$_store_cell($GlobalRBFChangedEvent$_constructor_riskBufferFundAfter_liquidityAfter_tradingFee_liquidation_trxId($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity, 0, 0, $trxId)));
    __tact_debug_str(__gen_slice_string_a4163e921dfe0673b3dd589bc6a070ca123d8b32e165dd120649f4f14103ae70());
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_decreaseRBFPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, slice $account, int $liquidityDelta, int $trxId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $rbfPositionOpt = $RBFPosition$_load_opt(__tact_dict_get_slice_cell($self'rbfPositions, 267, $account));
    throw_unless(5238, (~ null?($rbfPositionOpt)));
    var ($rbfPosition'positionId, $rbfPosition'liquidity, $rbfPosition'bonus, $rbfPosition'unlockTime) = $RBFPosition$_not_null($rbfPositionOpt);
    __tact_debug_str(__tact_int_to_string($rbfPosition'unlockTime));
    __tact_debug_str(__tact_int_to_string(now()));
    throw_unless(31425, ($rbfPosition'unlockTime <= now()));
    if (($rbfPosition'liquidity < $liquidityDelta)) {
        $liquidityDelta = $rbfPosition'liquidity;
    }
    int $totalGlobalUnrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl();
    throw_unless(23236, (($self'globalRBFPosition'riskBufferFund + $totalGlobalUnrealizedPnl) > 0));
    int $globalNetRBF = ($self'globalRBFPosition'riskBufferFund + ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl());
    if (($globalNetRBF < 0)) {
        $globalNetRBF = 0;
    }
    throw_unless(61867, ($globalNetRBF > 0));
    int $receive = 0;
    int $bonus = 0;
    if (($globalNetRBF >= $self'globalRBFPosition'liquidity)) {
        int $n = (((now() - $rbfPosition'unlockTime) + $self'rbfLockTime) / 86400);
        if (($rbfPosition'bonus == 0)) {
            $bonus = (((($liquidityDelta * $self'bonusFactor) * ($globalNetRBF - $self'globalRBFPosition'liquidity)) * min($n, 100)) / ($globalNetRBF * 1000));
        } else {
            int $bonus1 = (($liquidityDelta * ($globalNetRBF - $self'globalRBFPosition'liquidity)) / $globalNetRBF);
            int $bonus2 = $rbfPosition'bonus;
            int $bonus3 = (((($liquidityDelta * $self'bonusFactor) * ($globalNetRBF - $self'globalRBFPosition'liquidity)) * min($n, 100)) / ($globalNetRBF * 1000));
            $bonus = max(min($bonus1, $bonus2), $bonus3);
        }
        $receive = ($liquidityDelta + $bonus);
    } else {
        $receive = (($liquidityDelta * $globalNetRBF) / $self'globalRBFPosition'liquidity);
    }
    $rbfPosition'liquidity = ($rbfPosition'liquidity - $liquidityDelta);
    $rbfPosition'bonus = ($rbfPosition'bonus - $bonus);
    __tact_debug_str(__gen_slice_string_535e70d6b597da5ad67d92b6b36af7e0992cdca76b86675375f2eac7688563c0());
    __tact_debug_str(__tact_int_to_string(cell_hash(end_cell(__tact_store_address(begin_cell(), $account)))));
    if (( (($rbfPosition'liquidity > 0)) ? (true) : (($rbfPosition'bonus > 0)) )) {
        $self'rbfPositions~__tact_dict_set_slice_cell(267, $account, $RBFPosition$_store_cell(($rbfPosition'positionId, $rbfPosition'liquidity, $rbfPosition'bonus, $rbfPosition'unlockTime)));
    } else {
        $self'rbfPositions~__tact_dict_set_slice_cell(267, $account, $RBFPosition$_store_opt(null()));
    }
    $self'globalRBFPosition'riskBufferFund = ($self'globalRBFPosition'riskBufferFund - $receive);
    $self'globalRBFPosition'liquidity = ($self'globalRBFPosition'liquidity - $liquidityDelta);
    $global_emit($RBFPositionDecreasedEvent$_store_cell($RBFPositionDecreasedEvent$_constructor_positionId_account_liquidityDelta_liquidityAfter_bonusDelta_bonusAfter_receive_trxId($rbfPosition'positionId, $account, $liquidityDelta, $rbfPosition'liquidity, $bonus, $rbfPosition'bonus, $receive, $trxId)));
    $global_emit($GlobalRBFChangedEvent$_store_cell($GlobalRBFChangedEvent$_constructor_riskBufferFundAfter_liquidityAfter_tradingFee_liquidation_trxId($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity, 0, 0, $trxId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $receive);
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), tuple) $Pool$_fun_rbfPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, slice $account) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $RBFPosition$_load_opt(__tact_dict_get_slice_cell($self'rbfPositions, 267, $account)));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), ()) $Pool$_fun_increaseLPPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, slice $account, int $marginDelta, int $liquidityDelta, int $trxId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $lpPositionOpt = $LPPosition$_load_opt(__tact_dict_get_slice_cell($self'lpPositions, 267, $account));
    var ($lpPosition'positionId, $lpPosition'margin, $lpPosition'liquidity, $lpPosition'entryFundingFeeGrowth, $lpPosition'entryTradingFeeGrowth) = $LPPosition$_constructor_positionId_margin_liquidity_entryFundingFeeGrowth_entryTradingFeeGrowth(0, 0, 0, 0, 0);
    if ((~ null?($lpPositionOpt))) {
        ($lpPosition'positionId, $lpPosition'margin, $lpPosition'liquidity, $lpPosition'entryFundingFeeGrowth, $lpPosition'entryTradingFeeGrowth) = $LPPosition$_not_null($lpPositionOpt);
    } else {
        $lpPosition'positionId = $self'lpPositionIndexNext;
        $self'lpPositionIndexNext = ($self'lpPositionIndexNext + 1);
    }
    int $marginAfter = 0;
    int $fundingFee = 0;
    int $tradingFee = 0;
    if (($lpPosition'liquidity == 0)) {
        $marginAfter = $marginDelta;
        throw_unless(62409, ($marginAfter >= $self'minLPMargin));
        throw_unless(42634, (($marginAfter * $self'maxLPLeverage) >= $liquidityDelta));
    } else {
        $fundingFee = (($self'lpFundingFeeGrowth - $lpPosition'entryFundingFeeGrowth) * $lpPosition'liquidity);
        $tradingFee = (($self'lpTradingFeeGrowth - $lpPosition'entryTradingFeeGrowth) * $lpPosition'liquidity);
        $marginAfter = ((($lpPosition'margin + $tradingFee) + $fundingFee) + $marginDelta);
        int $globalUnrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl();
        int $unrealizedPnl = ((($globalUnrealizedPnl + $self'globalRBFPosition'riskBufferFund) * $self'globalLPLiquidity'liquidity) / $lpPosition'liquidity);
        int $unrealizedLoss = 0;
        if (($unrealizedPnl < 0)) {
            $unrealizedLoss = (- $unrealizedPnl);
        }
        throw_unless(60602, (((($marginAfter - $self'lpLiquidationFee) * $self'lpMaxRiskRate) / 1000000) > $unrealizedLoss));
        throw_unless(42634, (($marginAfter * $self'maxLPLeverage) >= $liquidityDelta));
    }
    $lpPosition'margin = $marginAfter;
    $lpPosition'liquidity = ($lpPosition'liquidity + $liquidityDelta);
    $lpPosition'entryFundingFeeGrowth = $self'lpFundingFeeGrowth;
    $lpPosition'entryTradingFeeGrowth = $self'lpTradingFeeGrowth;
    __tact_debug_str(__gen_slice_string_c9e0727b141e54cb092c7e6539e03d9783a8f1367129988ea22a50e8dcfbd97d());
    __tact_debug_str(__tact_int_to_string(cell_hash(end_cell(__tact_store_address(begin_cell(), $account)))));
    $self'lpPositions~__tact_dict_set_slice_cell(267, $account, $LPPosition$_store_cell(($lpPosition'positionId, $lpPosition'margin, $lpPosition'liquidity, $lpPosition'entryFundingFeeGrowth, $lpPosition'entryTradingFeeGrowth)));
    $self'globalLPLiquidity'margin = ($self'globalLPLiquidity'margin + $marginDelta);
    $self'globalLPLiquidity'liquidity = ($self'globalLPLiquidity'liquidity + $liquidityDelta);
    $global_emit($LPPositionIncreasedEvent$_store_cell($LPPositionIncreasedEvent$_constructor_positionId_account_marginDelta_marginAfter_liquidityDelta_liquidityAfter_tradingFee_fundingFee_trxId($lpPosition'positionId, $account, $marginDelta, $lpPosition'margin, $liquidityDelta, $lpPosition'liquidity, $tradingFee, $fundingFee, $trxId)));
    $global_emit($GlobalLPLiquidityChangedEvent$_store_cell($GlobalLPLiquidityChangedEvent$_constructor_marginAfter_liquidityAfter_trxId($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $trxId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_decreaseLPPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, slice $account, int $isLiquidate, int $marginDelta, int $liquidityDelta, int $trxId) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $lpPositionOpt = $LPPosition$_load_opt(__tact_dict_get_slice_cell($self'lpPositions, 267, $account));
    throw_unless(5238, (~ null?($lpPositionOpt)));
    var ($lpPosition'positionId, $lpPosition'margin, $lpPosition'liquidity, $lpPosition'entryFundingFeeGrowth, $lpPosition'entryTradingFeeGrowth) = $LPPosition$_not_null($lpPositionOpt);
    int $fundingFee = (($self'lpFundingFeeGrowth - $lpPosition'entryFundingFeeGrowth) * $lpPosition'liquidity);
    int $tradingFee = (($self'lpTradingFeeGrowth - $lpPosition'entryTradingFeeGrowth) * $lpPosition'liquidity);
    int $marginAfter = (($lpPosition'margin + $tradingFee) + $fundingFee);
    if ($isLiquidate) {
        $liquidityDelta = $lpPosition'liquidity;
    } else {
        if (($liquidityDelta > $lpPosition'liquidity)) {
            $liquidityDelta = $lpPosition'liquidity;
        }
        if (($marginAfter < $marginDelta)) {
            $marginDelta = $marginAfter;
        }
    }
    $marginAfter = $marginAfter - $marginDelta;
    int $liquidityAfter = ($lpPosition'liquidity - $liquidityDelta);
    int $globalUnrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl();
    int $unrealizedPnl = ((($globalUnrealizedPnl + $self'globalRBFPosition'riskBufferFund) * $self'globalLPLiquidity'margin) / $lpPosition'liquidity);
    int $unrealizedLoss = 0;
    if (($unrealizedPnl < 0)) {
        $unrealizedLoss = (- $unrealizedPnl);
    }
    int $receive = 0;
    if ($isLiquidate) {
        throw_unless(60602, (((($marginAfter - $self'lpLiquidationFee) * $self'lpMaxRiskRate) / 1000000) <= $unrealizedLoss));
        int $liquidationFee = $self'lpLiquidationFee;
        if (($marginAfter < $self'lpLiquidationFee)) {
            $liquidationFee = $marginAfter;
            $marginAfter = 0;
        } else {
            $marginAfter = ($marginAfter - $self'lpLiquidationFee);
        }
        $receive = $self'lpLiquidationFee;
        $self'globalRBFPosition'riskBufferFund = ($self'globalRBFPosition'riskBufferFund + $marginAfter);
        $self'lpPositions~__tact_dict_set_slice_cell(267, $account, $LPPosition$_store_opt(null()));
        $global_emit($LPPositionLiquidatedEvent$_store_cell($LPPositionLiquidatedEvent$_constructor_positionId_account_margin_liquidity_tradingFee_fundingFee_liquidationFee_trxId($lpPosition'positionId, $account, $lpPosition'margin, $lpPosition'liquidity, $tradingFee, $fundingFee, $liquidationFee, $trxId)));
        $global_emit($GlobalRBFChangedEvent$_store_cell($GlobalRBFChangedEvent$_constructor_riskBufferFundAfter_liquidityAfter_tradingFee_liquidation_trxId($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity, 0, 0, $trxId)));
    } else {
        throw_unless(62259, ((($self'globalRBFPosition'riskBufferFund + $self'globalLPLiquidity'liquidity) + $unrealizedPnl) >= $liquidityDelta));
        int $realizedLoss = 0;
        if (($liquidityAfter > 0)) {
            $realizedLoss = (($unrealizedLoss * $liquidityDelta) / $lpPosition'liquidity);
            if (($realizedLoss <= $marginDelta)) {
                $receive = ($marginDelta - $realizedLoss);
            } else {
                $receive = 0;
                $marginAfter = (($marginAfter + $marginDelta) - $realizedLoss);
            }
            throw_unless(22749, (((($marginAfter - $self'lpLiquidationFee) * $self'lpMaxRiskRate) / 1000000) > $unrealizedLoss));
            throw_unless(42634, (($marginAfter * $self'maxLPLeverage) >= $liquidityDelta));
            $lpPosition'margin = $marginAfter;
            $lpPosition'liquidity = $liquidityAfter;
            $lpPosition'entryFundingFeeGrowth = $self'lpFundingFeeGrowth;
            $lpPosition'entryTradingFeeGrowth = $self'lpTradingFeeGrowth;
            $self'lpPositions~__tact_dict_set_slice_cell(267, $account, $LPPosition$_store_cell(($lpPosition'positionId, $lpPosition'margin, $lpPosition'liquidity, $lpPosition'entryFundingFeeGrowth, $lpPosition'entryTradingFeeGrowth)));
        } else {
            $realizedLoss = $unrealizedLoss;
            $marginAfter = ($marginAfter - $realizedLoss);
            $receive = $marginAfter;
            $self'lpPositions~__tact_dict_set_slice_cell(267, $account, $LPPosition$_store_opt(null()));
        }
        $global_emit($LPPositionDecreasedEvent$_store_cell($LPPositionDecreasedEvent$_constructor_positionId_account_marginDelta_marginAfter_liquidityDelta_liquidityAfter_tradingFee_fundingFee_realizedLoss_receive_trxId($lpPosition'positionId, $account, $marginDelta, $lpPosition'margin, $liquidityDelta, $lpPosition'liquidity, $tradingFee, $fundingFee, $realizedLoss, $receive, $trxId)));
    }
    __tact_debug_str(__gen_slice_string_a51705071274ff74441265571fd72050dbd3b016392e8e260c7423300143d29e());
    $self'globalLPLiquidity'margin = ($self'globalLPLiquidity'margin - $marginDelta);
    $self'globalLPLiquidity'liquidity = ($self'globalLPLiquidity'liquidity - $liquidityDelta);
    $global_emit($GlobalLPLiquidityChangedEvent$_store_cell($GlobalLPLiquidityChangedEvent$_constructor_marginAfter_liquidityAfter_trxId($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $trxId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $receive);
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), tuple) $Pool$_fun_lpPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, slice $account) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $LPPosition$_load_opt(__tact_dict_get_slice_cell($self'lpPositions, 267, $account)));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_calculateEntryPrice((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $sizeBefore, int $entryPrice, int $sizeDelta, int $tradePrice) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    if (( (($sizeBefore == 0)) ? (($sizeDelta == 0)) : (false) )) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), 0);
    }
    if (($sizeBefore == 0)) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $tradePrice);
    }
    if (($sizeDelta == 0)) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $entryPrice);
    }
    int $liquidity = (($sizeBefore * $entryPrice) + ($sizeDelta * $tradePrice));
    int $sizeAfter = ($sizeBefore + $sizeDelta);
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ($liquidity / $sizeAfter));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), ()) $Pool$_fun_increasePerpPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $trxId, slice $account, int $tokenId, int $isLong, int $marginDelta, int $sizeDelta, int $tradePrice) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $tokenConfigOpt = $TokenConfig$_load_opt(__tact_dict_get_int_cell($self'tokenConfigs, 257, $tokenId));
    throw_unless(27798, (~ null?($tokenConfigOpt)));
    var ($tokenConfig'name, $tokenConfig'enable, $tokenConfig'minMargin, $tokenConfig'maxLeverage, $tokenConfig'liquidationFee, $tokenConfig'tradingFeeRate, $tokenConfig'lpTradingFeeRate, $tokenConfig'protocalTradingFeeRate, $tokenConfig'interestRate, $tokenConfig'maxFundingRate) = $TokenConfig$_not_null($tokenConfigOpt);
    throw_unless(36718, $tokenConfig'enable);
    tuple $accountPerpPositionOpt = $AccountPerpPosition$_load_opt(__tact_dict_get_int_cell($self'perpPositions, 257, $tokenId));
    var ($accountPerpPosition'positions) = ((~ null?($accountPerpPositionOpt)) ? $AccountPerpPosition$_not_null($accountPerpPositionOpt) : $AccountPerpPosition$_constructor_positions(null()));
    tuple $directionPerpPositionOpt = $DirectionPerpPosition$_load_opt(__tact_dict_get_slice_cell($accountPerpPosition'positions, 267, $account));
    var (($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth), ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth)) = ((~ null?($directionPerpPositionOpt)) ? $DirectionPerpPosition$_not_null($directionPerpPositionOpt) : $DirectionPerpPosition$_constructor_longPosition_shortPosition($PerpPosition$_constructor_positionId_margin_size_entryPrice_entryFundingFeeGrowth(0, 0, 0, 0, 0), $PerpPosition$_constructor_positionId_margin_size_entryPrice_entryFundingFeeGrowth(0, 0, 0, 0, 0)));
    var ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth) = ($isLong ? ($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth) : ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth));
    if (($perpPosition'size == 0)) {
        throw_unless(62409, ($marginDelta >= $tokenConfig'minMargin));
        $perpPosition'positionId = $self'perpPositionIndexNext;
        $self'perpPositionIndexNext = $self'perpPositionIndexNext + 1;
    }
    tuple $globalLpPositionOpt = $GlobalLPPosition$_load_opt(__tact_dict_get_int_cell($self'globalLPPositions, 257, $tokenId));
    var ($globalLpPosition'netSize, $globalLpPosition'isLong, $globalLpPosition'entryPrice) = ((~ null?($globalLpPositionOpt)) ? $GlobalLPPosition$_not_null($globalLpPositionOpt) : $GlobalLPPosition$_constructor_netSize_isLong_entryPrice(0, false, 0));
    int $lpRealizedPnl = 0;
    int $sizeRemaining = $sizeDelta;
    if (( (($globalLpPosition'netSize > 0)) ? (($isLong == $globalLpPosition'isLong)) : (false) )) {
        int $sizeUsed = (($sizeDelta > $globalLpPosition'netSize) ? $globalLpPosition'netSize : $sizeDelta);
        $lpRealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($isLong, $sizeUsed, $globalLpPosition'entryPrice, $tradePrice);
        $sizeRemaining = $sizeRemaining - $sizeUsed;
        $globalLpPosition'netSize = $globalLpPosition'netSize - $sizeUsed;
        if (($globalLpPosition'netSize == 0)) {
            $globalLpPosition'entryPrice = 0;
        }
    }
    if (($sizeRemaining > 0)) {
        $globalLpPosition'entryPrice = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateEntryPrice($globalLpPosition'netSize, $globalLpPosition'entryPrice, $sizeRemaining, $tradePrice);
        $globalLpPosition'netSize = $globalLpPosition'netSize + $sizeRemaining;
        $globalLpPosition'isLong = (~ $isLong);
    }
    int $tradingFee = ((($sizeDelta * $tradePrice) * $tokenConfig'tradingFeeRate) / (1000000 * 100000000000000000000));
    __tact_debug_str(__tact_int_to_string($tradingFee));
    int $lpTradingFee = (($tradingFee * $tokenConfig'lpTradingFeeRate) / 1000000);
    int $protocalTradingFee = (($tradingFee * $tokenConfig'protocalTradingFeeRate) / 1000000);
    int $rbfTradingFee = (($tradingFee - $lpTradingFee) - $protocalTradingFee);
    if (($self'globalLPLiquidity'liquidity != 0)) {
        $self'globalLPLiquidity'tradingFeeGrowth = $self'globalLPLiquidity'tradingFeeGrowth + (($lpTradingFee * 100000000000000000000) / $self'globalLPLiquidity'liquidity);
    } else {
        $protocalTradingFee = $protocalTradingFee + $lpTradingFee;
    }
    $self'protocalTradingFee = $self'protocalTradingFee + $protocalTradingFee;
    $self'globalRBFPosition'riskBufferFund = $self'globalRBFPosition'riskBufferFund + ($lpRealizedPnl + $rbfTradingFee);
    throw_unless(58161, ($globalLpPosition'netSize <= (($self'globalRBFPosition'riskBufferFund + ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl()) + $self'globalLPLiquidity'liquidity)));
    int $fundingFee = 0;
    $perpPosition'margin = $perpPosition'margin + (($marginDelta + $fundingFee) - $tradingFee);
    $perpPosition'entryPrice = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateEntryPrice($perpPosition'size, $perpPosition'entryPrice, $sizeDelta, $tradePrice);
    $perpPosition'size = $perpPosition'size + $sizeDelta;
    int $unrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($isLong, $perpPosition'size, $perpPosition'entryPrice, $tradePrice);
    int $maintenanceMargin = (((($perpPosition'size * $tradePrice) * $tokenConfig'tradingFeeRate) / (1000000 * 100000000000000000000)) + $tokenConfig'liquidationFee);
    __tact_debug_str(__tact_int_to_string($maintenanceMargin));
    __tact_debug_str(__tact_int_to_string($perpPosition'margin));
    throw_unless(28603, ($maintenanceMargin < ($perpPosition'margin + $unrealizedPnl)));
    throw_unless(42634, (($perpPosition'margin * $tokenConfig'maxLeverage) >= (($perpPosition'size * $perpPosition'entryPrice) / 100000000000000000000)));
    if ($isLong) {
        ($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth) = ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth);
    } else {
        ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth) = ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth);
    }
    $accountPerpPosition'positions~__tact_dict_set_slice_cell(267, $account, $DirectionPerpPosition$_store_cell((($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth), ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth))));
    $self'perpPositions~__tact_dict_set_int_cell(257, $tokenId, $AccountPerpPosition$_store_cell(($accountPerpPosition'positions)));
    $self'globalLPPositions~__tact_dict_set_int_cell(257, $tokenId, $GlobalLPPosition$_store_cell(($globalLpPosition'netSize, $globalLpPosition'isLong, $globalLpPosition'entryPrice)));
    $global_emit($PerpPositionIncreasedEvent$_store_cell($PerpPositionIncreasedEvent$_constructor_positionId_account_tokenId_isLong_marginDelta_marginAfter_sizeDelta_sizeAfter_tradePrice_entryPrice_tradingFee_fundingFee_trxId($perpPosition'positionId, $account, $tokenId, $isLong, $marginDelta, $perpPosition'margin, $sizeDelta, $perpPosition'size, $tradePrice, $perpPosition'entryPrice, $tradingFee, $fundingFee, $trxId)));
    $global_emit($GlobalLPPositionChangedEvent$_store_cell($GlobalLPPositionChangedEvent$_constructor_tokenId_netSizeAfter_isLong_entryPriceAfter_trxId($tokenId, $globalLpPosition'netSize, $globalLpPosition'isLong, $globalLpPosition'entryPrice, $trxId)));
    $global_emit($GlobalRBFChangedEvent$_store_cell($GlobalRBFChangedEvent$_constructor_riskBufferFundAfter_liquidityAfter_tradingFee_liquidation_trxId($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity, $rbfTradingFee, 0, $trxId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_fun_decreasePerpPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $trxId, int $isLiquidate, slice $account, int $tokenId, int $isLong, int $marginDelta, int $sizeDelta, int $tradePrice) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    tuple $tokenConfigOpt = $TokenConfig$_load_opt(__tact_dict_get_int_cell($self'tokenConfigs, 257, $tokenId));
    throw_unless(27798, (~ null?($tokenConfigOpt)));
    var ($tokenConfig'name, $tokenConfig'enable, $tokenConfig'minMargin, $tokenConfig'maxLeverage, $tokenConfig'liquidationFee, $tokenConfig'tradingFeeRate, $tokenConfig'lpTradingFeeRate, $tokenConfig'protocalTradingFeeRate, $tokenConfig'interestRate, $tokenConfig'maxFundingRate) = $TokenConfig$_not_null($tokenConfigOpt);
    throw_unless(36718, $tokenConfig'enable);
    tuple $accountPerpPositionOpt = $AccountPerpPosition$_load_opt(__tact_dict_get_int_cell($self'perpPositions, 257, $tokenId));
    var ($accountPerpPosition'positions) = ((~ null?($accountPerpPositionOpt)) ? $AccountPerpPosition$_not_null($accountPerpPositionOpt) : $AccountPerpPosition$_constructor_positions(null()));
    tuple $directionPerpPositionOpt = $DirectionPerpPosition$_load_opt(__tact_dict_get_slice_cell($accountPerpPosition'positions, 267, $account));
    var (($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth), ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth)) = ((~ null?($directionPerpPositionOpt)) ? $DirectionPerpPosition$_not_null($directionPerpPositionOpt) : $DirectionPerpPosition$_constructor_longPosition_shortPosition($PerpPosition$_constructor_positionId_margin_size_entryPrice_entryFundingFeeGrowth(0, 0, 0, 0, 0), $PerpPosition$_constructor_positionId_margin_size_entryPrice_entryFundingFeeGrowth(0, 0, 0, 0, 0)));
    var ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth) = ($isLong ? ($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth) : ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth));
    if ($isLiquidate) {
        $marginDelta = $perpPosition'margin;
        $sizeDelta = $perpPosition'size;
    } else {
        if (($sizeDelta > $perpPosition'size)) {
            $sizeDelta = $perpPosition'size;
        }
    }
    int $fundingFee = 0;
    if ($isLiquidate) {
        int $unrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($isLong, $perpPosition'size, $perpPosition'entryPrice, $tradePrice);
        int $maintenanceMargin = (((($perpPosition'size * $tradePrice) * $tokenConfig'tradingFeeRate) / (1000000 * 100000000000000000000)) + $tokenConfig'liquidationFee);
        throw_unless(18995, ($maintenanceMargin >= ($perpPosition'margin + $unrealizedPnl)));
        int $liquidatePrice = ((((($perpPosition'margin + $fundingFee) - $tokenConfig'liquidationFee) * 100000000000000000000) + ($isLong ? ((- $perpPosition'entryPrice) * $perpPosition'size) : ($perpPosition'entryPrice * $perpPosition'size))) / ($perpPosition'size * ($tokenConfig'tradingFeeRate + ($isLong ? (- 1000000) : 1000000))));
        throw_unless(55429, ($isLong ? ($liquidatePrice < $perpPosition'entryPrice) : ($liquidatePrice > $perpPosition'entryPrice)));
        $tradePrice = $liquidatePrice;
    }
    tuple $globalLpPositionOpt = $GlobalLPPosition$_load_opt(__tact_dict_get_int_cell($self'globalLPPositions, 257, $tokenId));
    var ($globalLpPosition'netSize, $globalLpPosition'isLong, $globalLpPosition'entryPrice) = ((~ null?($globalLpPositionOpt)) ? $GlobalLPPosition$_not_null($globalLpPositionOpt) : $GlobalLPPosition$_constructor_netSize_isLong_entryPrice(0, false, 0));
    int $lpRealizedPnl = 0;
    int $sizeRemaining = $sizeDelta;
    if (( (($globalLpPosition'netSize > 0)) ? (($isLong != $globalLpPosition'isLong)) : (false) )) {
        int $sizeUsed = (($sizeDelta > $globalLpPosition'netSize) ? $globalLpPosition'netSize : $sizeDelta);
        $lpRealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($isLong, $sizeUsed, $globalLpPosition'entryPrice, $tradePrice);
        $sizeRemaining = $sizeRemaining - $sizeUsed;
        $globalLpPosition'netSize = $globalLpPosition'netSize - $sizeUsed;
        if (($globalLpPosition'netSize == 0)) {
            $globalLpPosition'entryPrice = 0;
        }
    }
    if (($sizeRemaining > 0)) {
        $globalLpPosition'entryPrice = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateEntryPrice($globalLpPosition'netSize, $globalLpPosition'entryPrice, $sizeDelta, $tradePrice);
        $globalLpPosition'netSize = $globalLpPosition'netSize + $sizeRemaining;
        $globalLpPosition'isLong = (~ $isLong);
    }
    int $tradingFee = ((($sizeDelta * $tradePrice) * $tokenConfig'tradingFeeRate) / (1000000 * 100000000000000000000));
    int $lpTradingFee = (($tradingFee * $tokenConfig'lpTradingFeeRate) / 1000000);
    int $protocalTradingFee = (($tradingFee * $tokenConfig'protocalTradingFeeRate) / 1000000);
    int $rbfTradingFee = (($tradingFee - $lpTradingFee) - $protocalTradingFee);
    if (($self'globalLPLiquidity'liquidity != 0)) {
        $self'globalLPLiquidity'tradingFeeGrowth = $self'globalLPLiquidity'tradingFeeGrowth + (($lpTradingFee * 100000000000000000000) / $self'globalLPLiquidity'liquidity);
    } else {
        $protocalTradingFee = $protocalTradingFee + $lpTradingFee;
    }
    $self'protocalTradingFee = $self'protocalTradingFee + $protocalTradingFee;
    $self'globalRBFPosition'riskBufferFund = $self'globalRBFPosition'riskBufferFund + ($lpRealizedPnl + $rbfTradingFee);
    int $positionId = $perpPosition'positionId;
    int $receive = 0;
    if ($isLiquidate) {
        $receive = $tokenConfig'liquidationFee;
        ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth) = $PerpPosition$_constructor_positionId_margin_size_entryPrice_entryFundingFeeGrowth(0, 0, 0, 0, 0);
        $global_emit($PerpPositionLiquidatedEvent$_store_cell($PerpPositionLiquidatedEvent$_constructor_positionId_account_tokenId_isLong_marginDelta_sizeDelta_liquidatePrice_tradingFee_fundingFee_liquidationFee_trxId($positionId, $account, $tokenId, $isLong, $marginDelta, $sizeDelta, $tradePrice, $tradingFee, $fundingFee, $receive, $trxId)));
    } else {
        int $realizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($isLong, $sizeDelta, $perpPosition'entryPrice, $tradePrice);
        throw_unless(58161, ($globalLpPosition'netSize <= (($self'globalRBFPosition'riskBufferFund + ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateTotalGlobalUnrealizedPnl()) + $self'globalLPLiquidity'liquidity)));
        $perpPosition'margin = $perpPosition'margin + (($realizedPnl + $fundingFee) - $tradingFee);
        throw_unless(62409, ($perpPosition'margin >= 0));
        if (($marginDelta > $perpPosition'margin)) {
            $marginDelta = $perpPosition'margin;
        }
        $perpPosition'margin = $perpPosition'margin - $marginDelta;
        $perpPosition'entryPrice = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateEntryPrice($perpPosition'size, $perpPosition'entryPrice, $sizeDelta, $tradePrice);
        $perpPosition'size = $perpPosition'size - $sizeDelta;
        if (($perpPosition'size > 0)) {
            int $unrealizedPnl = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_calculateUnrealizedPnL($isLong, $perpPosition'size, $perpPosition'entryPrice, $tradePrice);
            int $maintenanceMargin = (((($perpPosition'size * $tradePrice) * $tokenConfig'tradingFeeRate) / (1000000 * 100000000000000000000)) + $tokenConfig'liquidationFee);
            throw_unless(28603, ($maintenanceMargin < ($perpPosition'margin + $unrealizedPnl)));
            throw_unless(42634, (($perpPosition'margin * $tokenConfig'maxLeverage) >= $perpPosition'size));
            $receive = $marginDelta;
        } else {
            $receive = $perpPosition'margin;
            ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth) = $PerpPosition$_constructor_positionId_margin_size_entryPrice_entryFundingFeeGrowth(0, 0, 0, 0, 0);
        }
        $global_emit($PerpPositionDecreasedEvent$_store_cell($PerpPositionDecreasedEvent$_constructor_positionId_account_tokenId_isLong_marginDelta_marginAfter_sizeDelta_sizeAfter_tradePrice_realizedPnLDelta_tradingFee_fundingFee_receive_trxId($perpPosition'positionId, $account, $tokenId, $isLong, $marginDelta, $perpPosition'margin, $sizeDelta, $perpPosition'size, $tradePrice, $realizedPnl, $tradingFee, $fundingFee, $receive, $trxId)));
    }
    if ($isLong) {
        ($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth) = ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth);
    } else {
        ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth) = ($perpPosition'positionId, $perpPosition'margin, $perpPosition'size, $perpPosition'entryPrice, $perpPosition'entryFundingFeeGrowth);
    }
    $accountPerpPosition'positions~__tact_dict_set_slice_cell(267, $account, $DirectionPerpPosition$_store_cell((($directionPerpPosition'longPosition'positionId, $directionPerpPosition'longPosition'margin, $directionPerpPosition'longPosition'size, $directionPerpPosition'longPosition'entryPrice, $directionPerpPosition'longPosition'entryFundingFeeGrowth), ($directionPerpPosition'shortPosition'positionId, $directionPerpPosition'shortPosition'margin, $directionPerpPosition'shortPosition'size, $directionPerpPosition'shortPosition'entryPrice, $directionPerpPosition'shortPosition'entryFundingFeeGrowth))));
    $self'perpPositions~__tact_dict_set_int_cell(257, $tokenId, $AccountPerpPosition$_store_cell(($accountPerpPosition'positions)));
    $self'globalLPPositions~__tact_dict_set_int_cell(257, $tokenId, $GlobalLPPosition$_store_cell(($globalLpPosition'netSize, $globalLpPosition'isLong, $globalLpPosition'entryPrice)));
    $global_emit($GlobalLPPositionChangedEvent$_store_cell($GlobalLPPositionChangedEvent$_constructor_tokenId_netSizeAfter_isLong_entryPriceAfter_trxId($tokenId, $globalLpPosition'netSize, $globalLpPosition'isLong, $globalLpPosition'entryPrice, $trxId)));
    $global_emit($GlobalRBFChangedEvent$_store_cell($GlobalRBFChangedEvent$_constructor_riskBufferFundAfter_liquidityAfter_tradingFee_liquidation_trxId($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity, $rbfTradingFee, 0, $trxId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $receive);
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), tuple) $Pool$_fun_perpPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $tokenId, slice $account) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    if (null?($AccountPerpPosition$_load_opt(__tact_dict_get_int_cell($self'perpPositions, 257, $tokenId)))) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), null());
    }
    var ($accountPerpPosition'positions) = $AccountPerpPosition$_not_null($AccountPerpPosition$_load_opt(__tact_dict_get_int_cell($self'perpPositions, 257, $tokenId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $DirectionPerpPosition$_load_opt(__tact_dict_get_slice_cell($accountPerpPosition'positions, 267, $account)));
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), ()) $Pool$_fun_setPrice((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, int $pricesLength, cell $prices) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    if (($pricesLength <= 0)) {
        return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
    }
    int $i = 0;
    while (($i < $pricesLength)) {
        tuple $updatePrice = $UpdatePrice$_load_opt(__tact_dict_get_int_cell($prices, 257, $i));
        if ((~ null?($updatePrice))) {
            int $price = $UpdatePrice$_get_price($UpdatePrice$_not_null($updatePrice));
            int $tokenId = $UpdatePrice$_get_tokenId($UpdatePrice$_not_null($updatePrice));
            tuple $priceDataOpt = $PriceData$_load_opt(__tact_dict_get_int_cell($self'prices, 257, $tokenId));
            if ((~ null?($priceDataOpt))) {
                var ($priceData'price) = $PriceData$_not_null($priceDataOpt);
                $priceData'price = $price;
                $self'prices~__tact_dict_set_int_cell(257, $tokenId, $PriceData$_store_cell(($priceData'price)));
            } else {
                $self'prices~__tact_dict_set_int_cell(257, $tokenId, $PriceData$_store_cell($PriceData$_constructor_price($price)));
            }
        }
        $i = ($i + 1);
    }
    $global_emit($UpdatePriceEvent$_store_cell($UpdatePriceEvent$_constructor_pricesLength_prices($pricesLength, $prices)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), ()) $Pool$_fun_requireOwner((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    throw_unless(132, ( __tact_slice_eq_bits($self'owner, __tact_context_get_sender()) ));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), slice) $Pool$_fun_owner((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self) impure inline_ref {
    var (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)) = $self;
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), $self'owner);
}

;;
;; Receivers of a Contract Pool
;;

(((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int)), ()) $Pool$_internal_binary_UpdateConfig((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, (int, int, int, int, int, int, int, int, slice) $msg) impure inline {
    var ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee) = $self;
    var ($msg'gasConsumption, $msg'minTonsForStorage, $msg'rbfLockTime, $msg'bonusFactor, $msg'minLPMargin, $msg'maxLPLeverage, $msg'lpLiquidationFee, $msg'lpMaxRiskRate, $msg'orderBook) = $msg;
    ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_requireOwner();
    $self'gasConsumption = $msg'gasConsumption;
    $self'minTonsForStorage = $msg'minTonsForStorage;
    $self'rbfLockTime = $msg'rbfLockTime;
    $self'bonusFactor = $msg'bonusFactor;
    $self'minLPMargin = $msg'minLPMargin;
    $self'maxLPLeverage = $msg'maxLPLeverage;
    $self'lpLiquidationFee = $msg'lpLiquidationFee;
    $self'lpMaxRiskRate = $msg'lpMaxRiskRate;
    $self'orderBook = $msg'orderBook;
    $global_send($SendParameters$_constructor_to_bounce_value_mode(__tact_context_get_sender(), false, 0, 64));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

(((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int)), ()) $Pool$_internal_binary_UpdateTokenConfig((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, (int, slice, int, int, int, int, int, int, int, int, int) $msg) impure inline {
    var ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee) = $self;
    var ($msg'tokenId, $msg'name, $msg'enable, $msg'minMargin, $msg'maxLeverage, $msg'liquidationFee, $msg'tradingFeeRate, $msg'lpTradingFeeRate, $msg'protocalTradingFeeRate, $msg'interestRate, $msg'maxFundingRate) = $msg;
    ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_requireOwner();
    tuple $tokenConfigOpt = $TokenConfig$_load_opt(__tact_dict_get_int_cell($self'tokenConfigs, 257, $msg'tokenId));
    var ($tokenConfig'name, $tokenConfig'enable, $tokenConfig'minMargin, $tokenConfig'maxLeverage, $tokenConfig'liquidationFee, $tokenConfig'tradingFeeRate, $tokenConfig'lpTradingFeeRate, $tokenConfig'protocalTradingFeeRate, $tokenConfig'interestRate, $tokenConfig'maxFundingRate) = $TokenConfig$_constructor_name_enable_minMargin_maxLeverage_liquidationFee_tradingFeeRate_lpTradingFeeRate_protocalTradingFeeRate_interestRate_maxFundingRate(__gen_slice_string_96a296d224f285c67bee93c30f8a309157f0daa35dc5b87e410b78630a09cfc7(), false, (10 * 1000000), 50, (2 * 100000), 1000, 300000, 300000, 0, 0);
    $tokenConfig'name = $msg'name;
    $tokenConfig'enable = $msg'enable;
    $tokenConfig'minMargin = $msg'minMargin;
    $tokenConfig'maxLeverage = $msg'maxLeverage;
    $tokenConfig'liquidationFee = $msg'liquidationFee;
    $tokenConfig'interestRate = $msg'interestRate;
    $tokenConfig'tradingFeeRate = $msg'tradingFeeRate;
    $tokenConfig'lpTradingFeeRate = $msg'lpTradingFeeRate;
    $tokenConfig'protocalTradingFeeRate = $msg'protocalTradingFeeRate;
    $tokenConfig'maxFundingRate = $msg'maxFundingRate;
    if (($msg'tokenId >= $self'tokenIdNext)) {
        $self'tokenIdNext = ($msg'tokenId + 1);
    }
    $self'tokenConfigs~__tact_dict_set_int_cell(257, $msg'tokenId, $TokenConfig$_store_cell(($tokenConfig'name, $tokenConfig'enable, $tokenConfig'minMargin, $tokenConfig'maxLeverage, $tokenConfig'liquidationFee, $tokenConfig'tradingFeeRate, $tokenConfig'lpTradingFeeRate, $tokenConfig'protocalTradingFeeRate, $tokenConfig'interestRate, $tokenConfig'maxFundingRate)));
    $global_send($SendParameters$_constructor_to_bounce_value_mode(__tact_context_get_sender(), false, 0, 64));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

(((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int)), ()) $Pool$_internal_binary_UpdateRBFPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, (int, int, slice, int, int, int, cell) $msg) impure inline {
    var ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee) = $self;
    var ($msg'isIncrease, $msg'orderId, $msg'account, $msg'liquidityDelta, $msg'trxId, $msg'pricesLength, $msg'prices) = $msg;
    __tact_debug_str(__gen_slice_string_3a9bf519c1f2bcd1dad1ca80bfb320028ba4ddbce4c231f81ce58b8b61daf1d0());
    throw_unless(41207, ( __tact_slice_eq_bits($self'orderBook, __tact_context_get_sender()) ));
    ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_setPrice($msg'pricesLength, $msg'prices);
    int $receive = 0;
    if ($msg'isIncrease) {
        ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_increaseRBFPosition($msg'account, $msg'liquidityDelta, $msg'trxId);
    } else {
        $receive = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_decreaseRBFPosition($msg'account, $msg'liquidityDelta, $msg'trxId);
    }
    int $msgValue = ((($Context$_get_value(__tact_context_get()) - ($self'gasConsumption * 2)) - $self'minTonsForStorage) - $Context$_fun_readForwardFee(__tact_context_get()));
    throw_unless(9429, ($msgValue > 0));
    $global_send($SendParameters$_constructor_to_value_bounce_mode_body($self'orderBook, $msgValue, false, 1, $UpdateRBFPositionSuccess$_store_cell($UpdateRBFPositionSuccess$_constructor_orderId_receive_trxId($msg'orderId, $receive, $msg'trxId))));
    __tact_debug_str(__gen_slice_string_d24569f45d9144ec127e16d8d415deb682cf4352347fe235e4115a97e1ed3535());
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

(((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int)), ()) $Pool$_internal_binary_UpdateLPPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, (int, int, slice, int, int, int, int, cell) $msg) impure inline {
    var ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee) = $self;
    var ($msg'orderId, $msg'opType, $msg'account, $msg'marginDelta, $msg'liquidityDelta, $msg'trxId, $msg'pricesLength, $msg'prices) = $msg;
    __tact_debug_str(__gen_slice_string_8516285cd5082ce3b9dc9315f81bf75f66f9b45ef58a15d68b47d6896e4e9b18());
    throw_unless(41207, ( __tact_slice_eq_bits($self'orderBook, __tact_context_get_sender()) ));
    ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_setPrice($msg'pricesLength, $msg'prices);
    int $receive = 0;
    if (($msg'opType == 1)) {
        ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_increaseLPPosition($msg'account, $msg'marginDelta, $msg'liquidityDelta, $msg'trxId);
    } elseif (($msg'opType == 2)) {
        $receive = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_decreaseLPPosition($msg'account, false, $msg'marginDelta, $msg'liquidityDelta, $msg'trxId);
    } else {
        $receive = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_decreaseLPPosition($msg'account, true, 0, 0, $msg'trxId);
    }
    int $msgValue = ((($Context$_get_value(__tact_context_get()) - ($self'gasConsumption * 2)) - $self'minTonsForStorage) - $Context$_fun_readForwardFee(__tact_context_get()));
    throw_unless(9429, ($msgValue > 0));
    $global_send($SendParameters$_constructor_to_value_bounce_mode_body($self'orderBook, $msgValue, false, 1, $UpdateLPPositionSuccess$_store_cell($UpdateLPPositionSuccess$_constructor_orderId_receive_trxId($msg'orderId, $receive, $msg'trxId))));
    __tact_debug_str(__gen_slice_string_dad7f839f24ebd4c09d8fa4970c3670f607e06fef5dfdf893e7aa31c25940441());
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

(((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int)), ()) $Pool$_internal_binary_UpdatePerpPosition((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, (int, int, int, slice, int, int, int, int, int, int, int, cell) $msg) impure inline {
    var ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee) = $self;
    var ($msg'orderId, $msg'opType, $msg'tokenId, $msg'account, $msg'isLong, $msg'marginDelta, $msg'sizeDelta, $msg'triggerPrice, $msg'triggerAbove, $msg'trxId, $msg'pricesLength, $msg'prices) = $msg;
    __tact_debug_str(__gen_slice_string_8516285cd5082ce3b9dc9315f81bf75f66f9b45ef58a15d68b47d6896e4e9b18());
    throw_unless(41207, ( __tact_slice_eq_bits($self'orderBook, __tact_context_get_sender()) ));
    ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_setPrice($msg'pricesLength, $msg'prices);
    int $tradePrice = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_getPrice($msg'tokenId);
    int $receive = 0;
    if (( (($msg'opType == 10)) ? (true) : (($msg'opType == 11)) )) {
        if ($msg'triggerAbove) {
            throw_unless(1644, ($tradePrice >= $msg'triggerPrice));
        } else {
            throw_unless(1644, ($tradePrice <= $msg'triggerPrice));
        }
        ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_increasePerpPosition($msg'trxId, $msg'account, $msg'tokenId, $msg'isLong, $msg'marginDelta, $msg'sizeDelta, $tradePrice);
    } elseif (($msg'opType == 3)) {
        $receive = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_decreasePerpPosition($msg'trxId, true, $msg'account, $msg'tokenId, $msg'isLong, 0, 0, $tradePrice);
    } else {
        if ($msg'triggerAbove) {
            throw_unless(1644, ($tradePrice >= $msg'triggerPrice));
        } else {
            throw_unless(1644, ($tradePrice <= $msg'triggerPrice));
        }
        $receive = ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_decreasePerpPosition($msg'trxId, false, $msg'account, $msg'tokenId, $msg'isLong, $msg'marginDelta, $msg'sizeDelta, $tradePrice);
    }
    int $msgValue = ((($Context$_get_value(__tact_context_get()) - ($self'gasConsumption * 2)) - $self'minTonsForStorage) - $Context$_fun_readForwardFee(__tact_context_get()));
    throw_unless(9429, ($msgValue > 0));
    $global_send($SendParameters$_constructor_to_value_bounce_mode_body($self'orderBook, $msgValue, false, 1, $UpdatePerpPositionSuccess$_store_cell($UpdatePerpPositionSuccess$_constructor_orderId_receive_trxId($msg'orderId, $receive, $msg'trxId))));
    __tact_debug_str(__gen_slice_string_c88b87ba336119ed1d9adc1f1e798539f9a2d5d21ee73835a33bc6a3303869b3());
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

(((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int)), ()) $Pool$_internal_binary_Deploy((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) $self, (int) $deploy) impure inline {
    var ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee) = $self;
    var ($deploy'queryId) = $deploy;
    ($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee)~$Pool$_fun_notify($DeployOk$_store_cell($DeployOk$_constructor_queryId($deploy'queryId)));
    return (($self'gasConsumption, $self'minTonsForStorage, $self'tokenConfigs, $self'tokenIdNext, $self'rbfLockTime, $self'bonusFactor, $self'minLPMargin, $self'maxLPLeverage, $self'lpLiquidationFee, $self'lpMaxRiskRate, $self'owner, $self'orderBook, $self'rbfPositions, $self'rbfPositionIndexNext, ($self'globalRBFPosition'riskBufferFund, $self'globalRBFPosition'liquidity), $self'lpPositions, $self'lpPositionIndexNext, ($self'globalLPLiquidity'margin, $self'globalLPLiquidity'liquidity, $self'globalLPLiquidity'fundingFeeGrowth, $self'globalLPLiquidity'tradingFeeGrowth), $self'globalLPPositions, $self'lpTradingFeeGrowth, $self'lpFundingFeeGrowth, $self'perpPositions, $self'perpPositionIndexNext, $self'prices, $self'protocalTradingFee), ());
}

;;
;; Get methods of a Contract Pool
;;

_ %configData() method_id(82657) {
    var self = $Pool$_contract_load();
    var res = self~$Pool$_fun_configData();
    return $ConfigData$_to_external(res);
}

_ %tokenConfig(int $$tokenId) method_id(124956) {
    int $tokenId = $$tokenId;
    var self = $Pool$_contract_load();
    var res = self~$Pool$_fun_tokenConfig($tokenId);
    return $TokenConfigData$_to_external(res);
}

_ %rbfPosition(slice $$account) method_id(130904) {
    slice $account = __tact_verify_address($$account);
    var self = $Pool$_contract_load();
    var res = self~$Pool$_fun_rbfPosition($account);
    return $RBFPosition$_to_opt_external(res);
}

_ %lpPosition(slice $$account) method_id(120059) {
    slice $account = __tact_verify_address($$account);
    var self = $Pool$_contract_load();
    var res = self~$Pool$_fun_lpPosition($account);
    return $LPPosition$_to_opt_external(res);
}

_ %perpPosition(int $$tokenId, slice $$account) method_id(105096) {
    int $tokenId = $$tokenId;
    slice $account = __tact_verify_address($$account);
    var self = $Pool$_contract_load();
    var res = self~$Pool$_fun_perpPosition($tokenId, $account);
    return $DirectionPerpPosition$_to_opt_external(res);
}

_ %owner() method_id(83229) {
    var self = $Pool$_contract_load();
    var res = self~$Pool$_fun_owner();
    return res;
}

_ supported_interfaces() method_id {
    return (
        "org.ton.introspection.v0"H >> 128,
        "org.ton.abi.ipfs.v0"H >> 128,
        "org.ton.deploy.lazy.v0"H >> 128,
        "org.ton.debug.v0"H >> 128,
        "org.ton.chain.workchain.v0"H >> 128,
        "org.ton.ownable"H >> 128
    );
}

_ get_abi_ipfs() method_id {
    return "ipfs://QmS5pYt7ZSaX4DYrsnUdvMu788YQKzNrSHCi1iyNTo2MBw";
}

_ lazy_deployment_completed() method_id {
    return get_data().begin_parse().load_int(1);
}

;;
;; Routing of a Contract Pool
;;

((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int), int) $Pool$_contract_router_internal((int, int, cell, int, int, int, int, int, int, int, slice, slice, cell, int, (int, int), cell, int, (int, int, int, int), cell, int, int, cell, int, cell, int) self, int msg_bounced, slice in_msg) impure inline_ref {
    ;; Handle bounced messages
    if (msg_bounced) {
        return (self, true);
    }
    
    ;; Parse incoming message
    int op = 0;
    if (slice_bits(in_msg) >= 32) {
        op = in_msg.preload_uint(32);
    }
    
    
    ;; Receive UpdateConfig message
    if (op == 1710201597) {
        var msg = in_msg~$UpdateConfig$_load();
        self~$Pool$_internal_binary_UpdateConfig(msg);
        return (self, true);
    }
    
    ;; Receive UpdateTokenConfig message
    if (op == 941711033) {
        var msg = in_msg~$UpdateTokenConfig$_load();
        self~$Pool$_internal_binary_UpdateTokenConfig(msg);
        return (self, true);
    }
    
    ;; Receive UpdateRBFPosition message
    if (op == 3902592095) {
        var msg = in_msg~$UpdateRBFPosition$_load();
        self~$Pool$_internal_binary_UpdateRBFPosition(msg);
        return (self, true);
    }
    
    ;; Receive UpdateLPPosition message
    if (op == 4272122737) {
        var msg = in_msg~$UpdateLPPosition$_load();
        self~$Pool$_internal_binary_UpdateLPPosition(msg);
        return (self, true);
    }
    
    ;; Receive UpdatePerpPosition message
    if (op == 4283950423) {
        var msg = in_msg~$UpdatePerpPosition$_load();
        self~$Pool$_internal_binary_UpdatePerpPosition(msg);
        return (self, true);
    }
    
    ;; Receive Deploy message
    if (op == 2490013878) {
        var msg = in_msg~$Deploy$_load();
        self~$Pool$_internal_binary_Deploy(msg);
        return (self, true);
    }
    
    return (self, false);
}

() recv_internal(int msg_value, cell in_msg_cell, slice in_msg) impure {
    
    ;; Context
    var cs = in_msg_cell.begin_parse();
    var msg_flags = cs~load_uint(4);
    var msg_bounced = -(msg_flags & 1);
    slice msg_sender_addr = __tact_verify_address(cs~load_msg_addr());
    __tact_context = (msg_bounced, msg_sender_addr, msg_value, cs);
    __tact_context_sender = msg_sender_addr;
    
    ;; Load contract data
    var self = $Pool$_contract_load();
    
    ;; Handle operation
    int handled = self~$Pool$_contract_router_internal(msg_bounced, in_msg);
    
    ;; Throw if not handled
    throw_unless(130, handled);
    
    ;; Persist state
    $Pool$_contract_store(self);
}
